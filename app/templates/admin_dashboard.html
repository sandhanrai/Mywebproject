{% extends "base.html" %}
{% block title %}Admin Dashboard - MediCheck{% endblock %}
{% block nav %}
<span style="color: #fff; font-weight: 700; font-size: 18px;">Admin</span>
{% endblock %}
{% block content %}
<style>
  /* Global font */
  body {
    font-family: 'Inter', 'Nunito', 'Open Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  }

  /* Forms */
  .form-control {
    background-color: #f5f5f5 !important;
    border: 1px solid #dcdcdc !important;
    color: #1c1c1c !important;
    box-shadow: none !important;
    border-radius: 8px !important;
    padding: 12px 16px !important;
    font-size: 1rem !important;
    transition: border-color 0.2s ease, background-color 0.2s ease !important;
  }
  .form-control:focus {
    border-color: #4DD0E1 !important;
    background-color: #fff !important;
    outline: none !important;
  }
  .form-label {
    font-weight: 600 !important;
    color: #000 !important;
  }

  /* Sidebar */
  .sidebar {
    position: fixed;
    left: 0;
    top: 80px;
    width: 25%;
    max-width: 300px;
    height: calc(100vh - 80px);
    background: linear-gradient(180deg, #a0d8d3 0%, #e0f0ef 100%);
    padding: 20px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .sidebar a {
    display: block;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    color: #004D40;
    text-decoration: none;
    font-weight: 600;
    font-size: 15.5px;
    border-radius: 10px;
    box-shadow: none;
    transition: all 0.2s ease-in-out;
    border: 1px solid rgba(0, 77, 64, 0.2);
    margin-bottom: 10px;
  }
  .sidebar a:hover {
    background: linear-gradient(45deg, #00AFA0, #26A69A);
    color: #FFFFFF;
    box-shadow: 0 4px 8px rgba(0, 175, 160, 0.3);
  }
  .sidebar a.active {
    background: linear-gradient(45deg, #009688, #00BCD4);
    color: #FFFFFF;
    box-shadow: 0 4px 8px rgba(0, 150, 136, 0.4);
  }
  .sidebar a.logout {
    color: #ff0000;
    margin-top: 20px;
  }
  .sidebar a.logout:hover {
    background-color: #ff0000;
    color: #fff;
  }

  /* Main Content */
  .main-content {
    margin-left: 25%;
    max-width: 75%;
    overflow-y: auto;
    height: calc(100vh - 100px);
    background: linear-gradient(180deg, #a0d8d3 0%, #e0f0ef 100%);
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  /* Headings */
  h1, h2, h3 {
    color: #004D40;
    font-weight: bold;
    font-size: 22px;
  }
  h4, h5, h6 {
    color: #004D40;
  }

  /* Labels */
  .form-label {
    font-size: 15px;
    font-weight: bold;
    color: #333333;
  }

  /* Body text */
  p, li {
    font-size: 15px;
    color: #444444;
  }

  /* Cards */
  .card {
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    margin-bottom: 20px;
  }
  .card-body {
    padding: 20px;
  }

  /* Buttons */
  .btn-primary {
    background: linear-gradient(90deg, #009688, #00BCD4);
    border: none;
    color: #fff;
    font-weight: 700;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 1rem;
    transition: all 0.2s ease-in-out;
  }
  .btn-primary:hover {
    box-shadow: 0 3px 8px rgba(0, 188, 212, 0.3);
    transform: translateY(-2px);
  }

  /* Tabs */
  .tab-pane {
    display: none;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
  }
  .tab-pane.active {
    display: block;
    opacity: 1;
  }

  /* Hamburger Menu */
  .hamburger {
    display: none;
    background: none;
    border: none;
    color: #009688;
    font-size: 24px;
    cursor: pointer;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar {
      width: 100%;
      position: static;
      height: auto;
      display: none;
    }
    .sidebar.show {
      display: block;
    }
    .main-content {
      margin-left: 0;
      width: 100%;
    }
    .hamburger {
      display: block;
    }
  }

  /* Admin specific */
  .section {
    display: none;
    margin-bottom: 40px;
  }
  .section.active {
    display: block;
  }
  .stats {
    display: flex;
    gap: 40px;
    margin-bottom: 40px;
  }
  .stat-card {
    background: #f5f5f5;
    border-radius: 12px;
    padding: 20px;
    flex: 1;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .stat-card h2 {
    font-size: 2rem;
    margin-bottom: 10px;
  }
  .stat-card p {
    font-size: 1rem;
    color: #555;
  }
  .section h3 {
    font-size: 1.8rem;
    margin-bottom: 20px;
    border-bottom: 2px solid #000;
    padding-bottom: 8px;
  }
  .chart-container {
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 12px 15px;
    border: 1px solid #ddd;
    text-align: left;
  }
  th {
    background: #eee;
  }
  button {
    background-color: #000;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  button:hover {
    background-color: #222;
  }
  .search-filter {
    margin-bottom: 20px;
  }
  .search-filter input {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-right: 10px;
  }

  #userDemographicsChart {
    width: 300px !important;
    height: 300px !important;
    display: block;
    margin: 0 auto;
  }

  #symptomTrendsChart {
    width: 800px !important;
    height: 600px !important;
    display: block;
    margin: 0 auto;
  }

  #systemMetricsChart {
    width: 800px !important;
    height: 600px !important;
    display: block;
    margin: 0 auto;
  }
</style>
    <div class="sidebar">
        <a href="#overview" class="active">Overview</a>
        <a href="#user-management">User & Patient Management</a>
        <a href="#symptom-analytics">Symptom Check & Health Data Analytics</a>
        <a href="#system-performance">System Performance & Usage</a>
        <a href="{{ url_for('logout') }}" class="logout">Logout</a>
    </div>
    <div class="main-content">
        <button class="hamburger" id="hamburger">â˜°</button>
        <section id="overview" class="section active">
            <h3>Dashboard Overview</h3>
            <div class="stats">
                <div class="stat-card">
                    <h2 id="totalUsers">{{ total_users }}</h2>
                    <p>Total Registered Users</p>
                </div>
                <div class="stat-card">
                    <h2 id="symptomChecksToday">{{ symptom_checks_today }}</h2>
                    <p>Symptom Checks Today</p>
                </div>
                <div class="stat-card">
                    <h2 id="activeUsers">{{ active_users }}</h2>
                    <p>Active Users</p>
                </div>
            </div>
        </section>

        <section id="user-management" class="section">
            <h3>User & Patient Management</h3>
            <div class="search-filter">
                <input type="text" id="userSearch" placeholder="Search users by ID, email, symptoms...">
                <button onclick="filterUsers()">Filter</button>
            </div>
            <div class="chart-container">
                <canvas id="userDemographicsChart"></canvas>
            </div>
            <div class="chart-container">
                <h4>User Activity Logs</h4>
                <table id="userActivityTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Last Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userActivityBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>

        <section id="symptom-analytics" class="section">
            <h3>Symptom Check & Health Data Analytics</h3>
            <div class="chart-container">
                <canvas id="symptomTrendsChart"></canvas>
            </div>
            <div class="chart-container">
                <h4>Most Common Symptoms</h4>
                <table id="symptomTable">
                    <thead>
                        <tr>
                            <th>Symptom</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody id="symptomBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>

        <section id="system-performance" class="section">
            <h3>System Performance & Usage</h3>
            <div class="chart-container">
                <canvas id="systemMetricsChart"></canvas>
            </div>
            <div class="chart-container">
                <h4>System Metrics</h4>
                <p>Total Symptom Checks: <span id="totalChecks">0</span></p>
                <p>Daily Average: <span id="dailyAverage">0</span></p>
            </div>
        </section>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Hamburger menu toggle
        const hamburger = document.getElementById('hamburger');
        const sidebar = document.querySelector('.sidebar');
        hamburger.addEventListener('click', () => {
          sidebar.classList.toggle('show');
        });

        // Sidebar navigation
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarLinks = document.querySelectorAll('.sidebar a[href^="#"]');
            const sections = document.querySelectorAll('.section');

            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(targetId);

                    // Remove active class from all sections and links
                    sections.forEach(section => section.classList.remove('active'));
                    sidebarLinks.forEach(l => l.classList.remove('active'));

                    // Add active to target
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                    this.classList.add('active');
                });
            });

            // Load data for all sections on page load
            loadAllData();
            loadOverviewStats();
        });

        function loadAllData() {
            // Fetch and display user demographics
            fetch('/admin/data/user_demographics')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('userDemographicsChart');
                    if (ctx) {
                        new Chart(ctx.getContext('2d'), {
                            type: 'pie',
                            data: {
                                labels: Object.keys(data.age_groups || {}),
                                datasets: [{
                                    data: Object.values(data.age_groups || {}),
                                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading user demographics:', error));

            // Fetch and display symptom trends
            fetch('/admin/data/symptom_trends')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('symptomTrendsChart');
                    if (ctx) {
                        new Chart(ctx.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: Object.keys(data),
                                datasets: [{
                                    label: 'Symptom Count',
                                    data: Object.values(data),
                                    backgroundColor: '#36A2EB'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }

                    // Populate symptom table
                    const tbody = document.getElementById('symptomBody');
                    if (tbody) {
                        tbody.innerHTML = ''; // Clear existing
                        Object.entries(data).forEach(([symptom, count]) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td>${symptom}</td><td>${count}</td>`;
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch(error => console.error('Error loading symptom trends:', error));

            // Fetch and display system metrics
            fetch('/admin/data/system_metrics')
                .then(response => response.json())
                .then(data => {
                    const totalChecksEl = document.getElementById('totalChecks');
                    if (totalChecksEl) {
                        totalChecksEl.textContent = data.total_checks || 0;
                    }
                    const dailyCount = Object.values(data.daily_checks || {}).length;
                    const dailyAvgEl = document.getElementById('dailyAverage');
                    if (dailyAvgEl) {
                        dailyAvgEl.textContent = dailyCount > 0 ? (data.total_checks / dailyCount).toFixed(1) : 0;
                    }

                    const ctx = document.getElementById('systemMetricsChart');
                    if (ctx) {
                        new Chart(ctx.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: Object.keys(data.daily_checks || {}),
                                datasets: [{
                                    label: 'Daily Checks',
                                    data: Object.values(data.daily_checks || {}),
                                    borderColor: '#FF6384',
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading system metrics:', error));

            // Fetch and display user activity
            fetch('/admin/data/user_activity')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('userActivityBody');
                    if (tbody) {
                        tbody.innerHTML = ''; // Clear existing
                        data.forEach(log => {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td>${log.username}</td><td>${new Date(log.created_at).toLocaleDateString()}</td><td><button onclick="deleteUser('${log.username}')" style="background-color: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Delete</button></td>`;
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch(error => console.error('Error loading user activity:', error));
        }

        function loadOverviewStats() {
            fetch('/admin/data/overview')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalUsers').textContent = data.total_users;
                    document.getElementById('symptomChecksToday').textContent = data.symptom_checks_today;
                    document.getElementById('activeUsers').textContent = data.active_users;
                })
                .catch(error => console.error('Error loading overview stats:', error));
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            // Implement filtering logic here
            console.log('Filtering users with term:', searchTerm);
        }
    </script>
{% endblock %}
