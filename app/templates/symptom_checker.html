{% extends "base.html" %}
{% block title %}Symptom Checker - MediCheck{% endblock %}
{% block content %}
<style>
  body {
    background: linear-gradient(135deg, #a0d8d3 0%, #e0f0ef 100%);
    font-family: 'Inter', 'Nunito', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    color: #1c1c1c;
    min-height: 100vh;
  }
  .container {
    max-width: 700px;
    margin: 40px auto;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
  }
  .progress-bar {
    margin-bottom: 32px;
    height: 12px;
    background: #f0f0f0;
    border-radius: 6px;
    overflow: hidden;
    position: relative;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #009688, #00BCD4);
    transition: width 0.5s ease-in-out;
    border-radius: 6px;
  }
  .step-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    color: #004D40;
  }
  .step-title i {
    color: #009688;
  }
  .form-group {
    margin-bottom: 20px;
  }
  .form-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    display: block;
  }
  .form-control {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    background: #fafafa;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  .form-control:focus {
    border-color: #009688;
    box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.1);
    outline: none;
  }
  .radio-group {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  .radio-option {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    transition: background 0.3s;
  }
  .radio-option:hover {
    background: #f0f7f6;
  }
  .radio-option input[type="radio"] {
    accent-color: #009688;
  }
  .btn {
    background: linear-gradient(135deg, #009688, #00BCD4);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3);
  }
  .btn-secondary {
    background: #6b6b6b;
  }
  .btn-secondary:hover {
    background: #888;
    box-shadow: 0 4px 12px rgba(107, 107, 107, 0.3);
  }
  .btn-group {
    display: flex;
    gap: 16px;
    justify-content: space-between;
    margin-top: 32px;
  }
  .symptom-input {
    position: relative;
  }
  .suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #e0f0ef;
    transition: all 0.3s ease;
    text-decoration: none;
    background: #ffffff;
    color: #004D40;
    font-weight: 500;
    border-radius: 8px;
    margin: 2px 0;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .suggestion-item:hover {
    background: #b2dfdb;
    color: #004D40;
    transform: translateX(5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .suggestion-item:before {
    content: "üîç";
    font-size: 1.2rem;
  }
  .selected-symptoms {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 16px;
  }
  .symptom-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #e0f2f1;
    color: #004D40;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    border: 1px solid #b2dfdb;
  }
  .symptom-chip .remove-btn {
    background: none;
    border: none;
    color: #d32f2f;
    cursor: pointer;
    font-weight: bold;
  }
  .prediction-card {
    background: #e8f5e8;
    border: 1px solid #c8e6c9;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
  }
  .chart-container {
    margin: 20px 0;
  }
  .disease-section {
    margin-bottom: 24px;
  }
  .disease-section h3 {
    color: #004D40;
    border-bottom: 2px solid #009688;
    padding-bottom: 8px;
    margin-bottom: 12px;
  }
  .disease-section ul {
    padding-left: 20px;
  }
  .disease-section li {
    margin-bottom: 8px;
  }
  @media (max-width: 768px) {
    .container {
      margin: 20px;
      padding: 20px;
    }
    .radio-group {
      flex-direction: column;
    }
    .btn-group {
      flex-direction: column;
    }
  }
</style>
<div class="container">
  {% if step %}
    <div class="progress-bar">
      <div class="progress-fill" style="width: {{ (step / 5) * 100 }}%;"></div>
    </div>
  {% endif %}

  {% if step == 1 %}
    <h1 class="step-title">
      <i class="fas fa-user"></i> Symptom Checker - Personal Info
    </h1>
    <p>Identify possible conditions and treatment related to your symptoms.</p>
    <p style="color: #6b6b6b; font-style: italic; margin-bottom: 24px;">This tool does not provide medical advice.</p>
    <form method="post">
      <div class="form-group">
        <label for="age" class="form-label">Age:</label>
        <input type="number" id="age" name="age" min="0" max="120" value="{{ session.get('age', 30) }}" required class="form-control">
      </div>
      <div class="form-group">
        <label class="form-label">Sex:</label>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" id="male" name="sex" value="Male" required {% if session.get('sex') == 'Male' %}checked{% endif %}>
            <i class="fas fa-mars"></i> Male
          </label>
          <label class="radio-option">
            <input type="radio" id="female" name="sex" value="Female" {% if session.get('sex') == 'Female' %}checked{% endif %}>
            <i class="fas fa-venus"></i> Female
          </label>
        </div>
      </div>
      <div class="btn-group">
        <button type="submit" name="continue_step1" class="btn">
          <i class="fas fa-arrow-right"></i> Continue
        </button>
      </div>
    </form>
  {% elif step == 2 %}
    <h1 class="step-title">
      <i class="fas fa-list-check"></i> Select Your Symptoms
    </h1>
    <p>Type your symptoms below and select from suggestions:</p>
    <form method="post">
      <div class="form-group">
        <label for="symptom_input" class="form-label">Enter Symptoms:</label>
          <div class="symptom-input">
            <input type="text" id="symptom_input" placeholder="Start typing a symptom..." autocomplete="off" class="form-control" style="border: 2px solid #009688; box-shadow: 0 0 8px rgba(0, 150, 136, 0.5); font-weight: 600; font-size: 1.1rem; padding: 14px 18px; border-radius: 12px;">
            <div id="suggestions" class="suggestions" style="border: 2px solid #009688; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 150, 136, 0.3); background: #e0f2f1; font-weight: 600; font-size: 1rem; color: #004D40;"></div>
          </div>
      </div>
      <div class="form-group">
        <label class="form-label">Selected Symptoms:</label>
        <div id="selected_symptoms" class="selected-symptoms">
          {% for symptom, selected in session.get('selected_symptoms', {}).items() %}
            {% if selected %}
              <div class="symptom-chip">
                {{ symptom.replace('_', ' ').title() }}
                <button type="button" class="remove-symptom remove-btn" data-symptom="{{ symptom }}">√ó</button>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      <input type="hidden" id="selected_symptoms_hidden" name="selected_symptoms"
        value="{% for s, sel in session.get('selected_symptoms', {}).items() if sel %}{{ s }}{% if not loop.last %},{% endif %}{% endfor %}">
      <div class="btn-group">
        <button type="submit" name="back_step2" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button type="submit" name="get_prediction" class="btn">
          <i class="fas fa-brain"></i> Get Prediction
        </button>
      </div>
    </form>
  {% elif step == 3 %}
    <h1 class="step-title">
      <i class="fas fa-chart-bar"></i> Possible Conditions
    </h1>
    <p>Age: {{ session.get('age') }} | Sex: {{ session.get('sex') }}</p>
    <p>Based on your symptoms, here are the possible conditions:</p>
    {% set result = session.get('prediction_result') %}
    {% if result %}
      <div class="prediction-card">
        <h2>Most Likely Condition: {{ result.primary_prediction }}</h2>
      </div>
      <h3>Other Possible Conditions</h3>
      <ul>
        {% for pred in result.all_predictions[1:4] %}
          <li>
            {{ pred.disease }}<br>
            {% if pred.probability >= 0.75 %}
              <strong>STRONG match</strong>
            {% elif pred.probability >= 0.5 %}
              <strong>Moderate match</strong>
            {% elif pred.probability >= 0.25 %}
              <strong>Fair match</strong>
            {% else %}
              <strong>Weak match</strong>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
    <form method="post">
      <div class="btn-group">
        <button type="submit" name="back_step3" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button type="submit" name="next_step3" class="btn">
          <i class="fas fa-arrow-right"></i> Next
        </button>
      </div>
    </form>
  {% elif step == 4 %}
    <h1 class="step-title">
      <i class="fas fa-info-circle"></i> Disease Details
    </h1>
    {% if disease_info %}
      {% if disease_info.summary %}
      <div class="disease-section">
        <h3>Summary</h3>
        <p>{{ disease_info.summary | safe }}</p>
      </div>
      {% endif %}
      {% if disease_info.causes %}
      <div class="disease-section">
        <h3>Causes</h3>
        <ul>
          {% for cause in disease_info.causes %}
          <li>{{ cause | safe }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if disease_info.symptoms %}
      <div class="disease-section">
        <h3>Symptoms</h3>
        <ul>
          {% for symptom in disease_info.symptoms %}
          <li>{{ symptom | safe }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if disease_info.prevention %}
      <div class="disease-section">
        <h3>Prevention</h3>
        <ul>
          {% for prev in disease_info.prevention %}
          <li>{{ prev | safe }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if disease_info.diagnosis %}
      <div class="disease-section">
        <h3>Diagnosis</h3>
        <ul>
          {% for diag in disease_info.diagnosis %}
          <li>{{ diag | safe }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if disease_info.related %}
      <div class="disease-section">
        <h3>Related Conditions</h3>
        <ul>
          {% for rel in disease_info.related %}
          <li>{{ rel | safe }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    {% else %}
      <p>Disease details not available at the moment.</p>
    {% endif %}
    <form method="post">
      <div class="btn-group">
        <button type="submit" name="back_step4" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button type="submit" name="next_step4" class="btn">
          <i class="fas fa-arrow-right"></i> Next
        </button>
      </div>
    </form>
  {% elif step == 5 %}
    <h1 class="step-title">
      <i class="fas fa-pills"></i> Treatments & Therapies
    </h1>
    {% if disease_info and disease_info.treatments %}
      <div class="disease-section">
        <ul>
          {% for treat in disease_info.treatments %}
          <li>{{ treat | safe }}</li>
          {% endfor %}
        </ul>
      </div>
      {% if disease_info.source %}
      <p><a href="{{ disease_info.source }}" target="_blank" class="btn">View Full Page on MedlinePlus</a></p>
      {% endif %}
    {% else %}
      <p>Treatment information not available at the moment.</p>
    {% endif %}
    <form method="post">
      <div class="btn-group">
        <button type="submit" name="back_step5" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button type="submit" name="restart" class="btn">
          <i class="fas fa-redo"></i> Restart
        </button>
      </div>
    </form>
  {% endif %}
</div>
<script>
  {% if step == 2 %}
    const symptomInput = document.getElementById('symptom_input');
    const suggestionsDiv = document.getElementById('suggestions');
    const selectedSymptomsUl = document.getElementById('selected_symptoms');
    const selectedSymptomsHidden = document.getElementById('selected_symptoms_hidden');
    let selectedSymptoms = new Set({{ selected_list | tojson }});

    function updateHiddenInput() {
      selectedSymptomsHidden.value = Array.from(selectedSymptoms).join(',');
    }

    function addSymptom(symptom) {
      if (!selectedSymptoms.has(symptom)) {
        selectedSymptoms.add(symptom);
        const chip = document.createElement('div');
        chip.className = 'symptom-chip';
        chip.innerHTML = `${symptom.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} <button type="button" class="remove-btn" data-symptom="${symptom}">√ó</button>`;
        selectedSymptomsUl.appendChild(chip);
        updateHiddenInput();
      }
      symptomInput.value = '';
      suggestionsDiv.innerHTML = '';
    }

    symptomInput.addEventListener('input', function() {
      const query = this.value.trim();
      if (query.length < 2) {
        suggestionsDiv.innerHTML = '';
        return;
      }
      fetch(`/api/symptom_suggestions?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(suggestions => {
          suggestionsDiv.innerHTML = '';
          suggestions.forEach(symptom => {
            if (!selectedSymptoms.has(symptom)) {
              const item = document.createElement('button');
              item.className = 'suggestion-item';
              item.textContent = symptom.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              item.addEventListener('click', () => addSymptom(symptom));
              suggestionsDiv.appendChild(item);
            }
          });
        });
    });

    selectedSymptomsUl.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-btn')) {
        const symptom = e.target.dataset.symptom;
        selectedSymptoms.delete(symptom);
        e.target.closest('.symptom-chip').remove();
        updateHiddenInput();
      }
    });
  {% endif %}

  {% if step == 3 %}
  {% endif %}
</script>
{% endblock %}
